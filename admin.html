<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Tableau de Bord Professeur</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
    }

    .success {
      color: green;
      font-weight: bold;
    }

    .count {
      background: #3a7bd5;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8em;
    }
  </style>
</head>

<body>

  <h1>üë®‚Äçüè´ Suivi des √©l√®ves</h1>
  <button id="authBtn" onclick="login()">Se connecter (Prof uniquement)</button>
  <div id="loading">En attente de connexion...</div>

  <div style="margin: 20px 0;">
    <button onclick="exportCSV()"
      style="background-color: #28a745; color: white; padding: 10px 15px; border:none; border-radius:5px; cursor:pointer;">
      üì• T√©l√©charger les r√©sultats (.csv)
    </button>
  </div>

  <table id="resultsTable" style="display:none;">
    <thead>
      <tr>
        <th>Email √âl√®ve</th>
        <th>Score</th>
        <th>Note / 20</th>
        <th>D√©tails (Exercices r√©ussis)</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- REMETS TA CONFIGURATION FIREBASE ICI ---
    const firebaseConfig = {
      apiKey: "AIzaSyBGzMQwqbE1yPgoMfxvhgIeX7Qo0wBVJc4",
      authDomain: "learnpython-1d8d0.firebaseapp.com",
      projectId: "learnpython-1d8d0",
      storageBucket: "learnpython-1d8d0.firebasestorage.app",
      messagingSenderId: "975177947496",
      appId: "1:975177947496:web:30410a3f24860816bc5edd"

    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Liste des titres pour afficher des noms au lieu des num√©ros
    // Tu peux copier juste les titres de ton index.html
    const exosTitres = [
      "1. Multiples de 3", "2. Somme cubes", "3. Table mult",
      "4. Factorielle", "5. PGCD", "6. Premier",
      "7. Liste Premiers", "8. Inverse cha√Æne"
      // ... ajoute les autres si besoin pour avoir l'affichage complet
    ];

    // On calcule le d√©nominateur une fois pour toutes : remplacer 25 par exosTitres.length;
    const TOTAL_EXOS = 23; // Mets ici le nombre total d'exos disponibles
    // AJOUT : Variable globale pour stocker les donn√©es des √©l√®ves
    let studentsData = [];

    window.login = async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        document.getElementById("authBtn").style.display = "none";
        document.getElementById("loading").innerText = "Chargement des donn√©es...";
        loadData();
      } catch (error) {
        alert("Erreur: " + error.message);
      }
    };

    async function loadData() {
      try {
        // R√©cup√©rer TOUS les documents de la collection "users"
        const querySnapshot = await getDocs(collection(db, "users"));

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        studentsData = []; // On vide la liste avant de remplir

        if (querySnapshot.empty) {
          document.getElementById("loading").innerText = "Aucun √©l√®ve trouv√©.";
          return;
        }

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const email = data.email || "Email inconnu";
          const completed = data.completed || [];

          // --- CALCUL DE LA NOTE ---
          const score = completed.length;
          // Calcul : (Score / Total) * 20. On arrondit √† 1 d√©cimale (ex: 14.5)
          let note = TOTAL_EXOS > 0 ? (score / TOTAL_EXOS) * 20 : 0;
          note = parseFloat(note.toFixed(1)); // Rend le nombre propre

          // Couleur conditionnelle pour la note (Facultatif mais sympa)
          let color = "red";
          if (note >= 10) color = "orange";
          if (note >= 14) color = "green";
          if (note === 20) color = "#28a745; font-weight:bold";

          // Stockage pour l'export CSV
          studentsData.push({
            email: email,
            score: score,
            note: note, // On ajoute la note ici
            details: completed.sort((a, b) => a - b).map(i => i + 1).join(";")
          });

          // Affichage dans le tableau
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${email}</td>
                    <td><span class="count">${score} / ${TOTAL_EXOS}</span></td>
                    <td style="color:${color}; font-size:1.1em;">${note}</td>
                    <td style="font-size:0.85em; color:#666;">${completed.length > 0 ? "Exos: " + completed.sort((a, b) => a - b).map(i => i + 1).join(", ") : "-"}</td>
                `;
          tbody.appendChild(tr);
        });

        document.getElementById("resultsTable").style.display = "table";
        document.getElementById("loading").style.display = "none";

      } catch (error) { console.error(error); }
    }

    window.exportCSV = () => {
      if (studentsData.length === 0) { alert("Aucune donn√©e."); return; }

      let csvContent = "data:text/csv;charset=utf-8,";
      // On ajoute la colonne Note dans l'ent√™te
      csvContent += "Email,Score (Nb),Note / 20,Exercices Reussis\r\n";

      studentsData.forEach(st => {
        // Note : on remplace le point d√©cimal par une virgule pour Excel fran√ßais si besoin
        // st.note.toString().replace('.', ',')
        const row = `${st.email},${st.score},${st.note},"${st.details}"`;
        csvContent += row + "\r\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `resultats_notes_${new Date().toISOString().slice(0, 10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>

</html>