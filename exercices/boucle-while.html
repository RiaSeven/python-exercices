<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exercices Python Interactifs</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
  <style>
    :root {
      --primary: #3a7bd5;
      --secondary: #00d2ff;
      --bg: #f4f7f6;
      --text: #333;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .main-container {
      width: 100%;
      max-width: 1000px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .progress-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    /* Consigne */
    .content {
      padding: 20px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .consigne-box {
      background: #eef2f5;
      border-left: 5px solid var(--primary);
      padding: 15px;
      border-radius: 4px;
    }

    .consigne-box h2 {
      margin-top: 0;
      color: var(--primary);
      font-size: 1.2rem;
    }

    code {
      background: #e0e0e0;
      padding: 2px 5px;
      border-radius: 4px;
      font-family: monospace;
      color: #d63384;
    }

    /* Editeur */
    #editor-container {
      position: relative;
      height: 350px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    #editor {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      font-size: 16px;
    }

    /* Controls */
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    button {
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-size: 1rem;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-run {
      background: #28a745;
      color: white;
    }

    .btn-run:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    .btn-reset {
      background: #ffc107;
      color: #333;
    }

    .btn-reset:hover {
      background: #e0a800;
    }

    .btn-nav {
      background: #6c757d;
      color: white;
    }

    .btn-nav:hover {
      background: #5a6268;
    }

    /* Output & Status */
    .output-area {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      min-height: 80px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
    }

    .status-msg {
      margin-top: 10px;
      padding: 15px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      display: none;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, .3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>

  <div class="main-container">
    <div class="header">
      <h1>üêç Python : Exercices Interactifs</h1>
      <span class="progress-badge" id="progressText">Chargement...</span>
    </div>

    <div class="content">
      <div class="consigne-box">
        <h2 id="exTitle">Titre de l'exercice</h2>
        <div id="exInstruction">Chargement des exercices...</div>
      </div>

      <div id="editor-container">
        <div id="editor"># Chargement de l'environnement Python...</div>
      </div>

      <div class="controls">
        <div class="btn-group">
          <button class="btn-run" onclick="runCode()" id="runBtn" disabled>
            <span id="btnIcon">‚ñ∂</span> Ex√©cuter
          </button>
          <button class="btn-reset" onclick="resetCode()">‚Ü∫ R√©initialiser</button>
        </div>
        <div class="btn-group">
          <button class="btn-nav" onclick="prevExercise()" id="btnPrev">‚Üê Pr√©c√©dent</button>
          <button class="btn-nav" onclick="nextExercise()" id="btnNext">Suivant ‚Üí</button>
        </div>
      </div>

      <div>
        <h3>R√©sultat / Console :</h3>
        <div id="output" class="output-area">Initialisation de Pyodide...</div>
        <div id="status" class="status-msg"></div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // DONN√âES DES EXERCICES (100% Fonctions / Sans Input)
    // ==========================================
    const exercices = [
      {
        titre: "Multiples de 3",
        consigne: "√âcrire une boucle qui affiche les multiples de 3 entre 1 et 50 (3, 6, 9...). Un nombre par ligne.",
        code: "for i in range(1, 51):\n    # Votre code ici",
        validation: { type: "output_list", values: ["3", "6", "9", "12", "15", "18", "21", "24", "27", "30", "33", "36", "39", "42", "45", "48"] }
      },
      {
        titre: "Somme des cubes",
        consigne: "√âcrire une fonction <code>somme_cubes(n)</code> qui retourne la somme des cubes des entiers de 1 √† <code>n</code>.",
        code: "def somme_cubes(n):\n    # Votre code ici",
        validation: { type: "function", tests: ["assert somme_cubes(3) == 36", "assert somme_cubes(1) == 1", "assert somme_cubes(2) == 9"] }
      },
      {
        titre: "Factorielle",
        consigne: "√âcrire une fonction <code>factorielle(n)</code> qui calcule la factorielle de n.",
        code: "def factorielle(n):\n    res = 1\n    # Compl√©tez la boucle\n    return res",
        validation: { type: "function", tests: ["assert factorielle(5) == 120", "assert factorielle(3) == 6", "assert factorielle(0) == 1"] }
      },
      {
        titre: "PGCD",
        consigne: "√âcrire une fonction <code>pgcd(a, b)</code> qui retourne le Plus Grand Commun Diviseur.",
        code: "import math\ndef pgcd(a, b):\n    # Vous pouvez utiliser l'algorithme d'Euclide\n    return 1",
        validation: { type: "function", tests: ["assert pgcd(48, 18) == 6", "assert pgcd(10, 5) == 5", "assert pgcd(17, 3) == 1"] }
      },
      {
        titre: "Nombre premier",
        consigne: "√âcrire une fonction <code>est_premier(n)</code> qui retourne True si n est premier, False sinon.",
        code: "def est_premier(n):\n    if n < 2: return False\n    # Votre logique ici\n    return True",
        validation: { type: "function", tests: ["assert est_premier(7) == True", "assert est_premier(8) == False", "assert est_premier(11) == True"] }
      },
      {
        titre: "Nombres premiers (1-100)",
        consigne: "Affichez tous les nombres premiers entre 1 et 100, un par ligne.",
        code: "# Vous pouvez r√©utiliser votre fonction est_premier si vous la copiez ici\nfor i in range(1, 101):\n    pass",
        validation: { type: "output_list", values: ["2", "3", "5", "7", "11", "13", "17", "19", "23", "29", "31", "37", "41", "43", "47", "53", "59", "61", "67", "71", "73", "79", "83", "89", "97"] }
      },
      {
        titre: "Inverser une cha√Æne",
        consigne: "√âcrire une fonction <code>inverse_chaine(chaine)</code> qui retourne la cha√Æne invers√©e.",
        code: "def inverse_chaine(chaine):\n    return \"\" # √Ä modifier",
        validation: { type: "function", tests: ["assert inverse_chaine('bonjour') == 'ruojnob'", "assert inverse_chaine('Python') == 'nohtyP'"] }
      },
      {
        titre: "Compter les mots",
        consigne: "√âcrire une fonction <code>compter_mots(phrase)</code> qui retourne le nombre de mots (s√©par√©s par des espaces).",
        code: "def compter_mots(phrase):\n    # Indice: utilisez split()\n    return 0",
        validation: { type: "function", tests: ["assert compter_mots('Bonjour le monde') == 3", "assert compter_mots('Un') == 1"] }
      },
      {
        titre: "Palindrome",
        consigne: "Fonction <code>est_palindrome(chaine)</code> retournant True si c'est un palindrome (se lit pareil dans les deux sens).",
        code: "def est_palindrome(chaine):\n    return False",
        validation: { type: "function", tests: ["assert est_palindrome('radar') == True", "assert est_palindrome('python') == False", "assert est_palindrome('kayak') == True"] }
      },
      {
        titre: "Lancer de d√© (Simulation)",
        consigne: "√âcrire une fonction <code>lancer_de()</code> qui retourne un entier al√©atoire entre 1 et 6.",
        code: "import random\ndef lancer_de():\n    return 0",
        validation: { type: "function", tests: ["assert 1 <= lancer_de() <= 6", "assert isinstance(lancer_de(), int)"] }
      },
      {
        titre: "Puissance",
        consigne: "Fonction <code>puissance(x, n)</code> calculant x^n sans utiliser `**`.",
        code: "def puissance(x, n):\n    res = 1\n    # Boucle pour multiplier x par lui-m√™me n fois\n    return res",
        validation: { type: "function", tests: ["assert puissance(2, 3) == 8", "assert puissance(5, 2) == 25"] }
      },
      {
        titre: "Suite de Syracuse",
        consigne: "Affichez les termes de la suite de Syracuse pour N=6 jusqu'√† atteindre 1. (Rappel: pair->n/2, impair->3n+1)",
        code: "n = 6\nwhile n != 1:\n    print(int(n))\n    # Logique ici\n    break # S√©curit√© boucle infinie",
        validation: { type: "output_includes", values: ["6", "3", "10", "5", "16", "8", "4", "2"] }
      },
      {
        titre: "Somme des chiffres",
        consigne: "Fonction <code>somme_chiffres(n)</code> retournant la somme des chiffres (ex: 123 -> 6).",
        code: "def somme_chiffres(n):\n    # Astuce: convertir en string ou utiliser le modulo\n    return 0",
        validation: { type: "function", tests: ["assert somme_chiffres(123) == 6", "assert somme_chiffres(405) == 9"] }
      },
      {
        titre: "Nombre d'Armstrong",
        consigne: "Un nombre est Armstrong si la somme des cubes de ses chiffres est √©gale au nombre. Fonction <code>est_armstrong(n)</code>.",
        code: "def est_armstrong(n):\n    return False",
        validation: { type: "function", tests: ["assert est_armstrong(153) == True", "assert est_armstrong(10) == False", "assert est_armstrong(370) == True"] }
      },
      {
        titre: "Nombre parfait",
        consigne: "Un nombre est parfait s'il est √©gal √† la somme de ses diviseurs propres. Fonction <code>est_parfait(n)</code>.",
        code: "def est_parfait(n):\n    somme_div = 0\n    # Calculez la somme des diviseurs < n\n    return somme_div == n",
        validation: { type: "function", tests: ["assert est_parfait(6) == True", "assert est_parfait(28) == True", "assert est_parfait(12) == False"] }
      },
      {
        titre: "Nombres parfaits < 1000",
        consigne: "Affichez tous les nombres parfaits inf√©rieurs √† 1000.",
        code: "for n in range(1, 1000):\n    # Code pour v√©rifier et afficher\n    pass",
        validation: { type: "output_list", values: ["6", "28", "496"] }
      },
      {
        titre: "Nombres amis",
        consigne: "Fonction <code>est_ami(a, b)</code>. Deux nombres sont amis si la somme des diviseurs de a vaut b et inversement.",
        code: "def est_ami(a, b):\n    return False",
        validation: { type: "function", tests: ["assert est_ami(220, 284) == True", "assert est_ami(10, 12) == False"] }
      },
      {
        titre: "Conversion Temp√©rature",
        consigne: "Fonction <code>celsius_vers_fahrenheit(c)</code>. Formule : (c * 9/5) + 32.",
        code: "def celsius_vers_fahrenheit(c):\n    return 0",
        validation: { type: "function", tests: ["assert celsius_vers_fahrenheit(0) == 32", "assert celsius_vers_fahrenheit(100) == 212"] }
      },
      {
        titre: "Volume d'une boule",
        consigne: "Fonction <code>volume_boule(rayon)</code>. Formule : (4/3) * pi * r^3.",
        code: "import math\ndef volume_boule(rayon):\n    return 0",
        validation: { type: "function", tests: ["assert abs(volume_boule(1) - 4.188) < 0.01"] }
      },
      {
        titre: "Jours dans un mois",
        consigne: "Fonction <code>nb_jours(mois, annee)</code>. Attention aux ann√©es bissextiles pour f√©vrier.",
        code: "def nb_jours(mois, annee):\n    if mois in [1, 3, 5, 7, 8, 10, 12]: return 31\n    # Compl√©tez la logique\n    return 30",
        validation: { type: "function", tests: ["assert nb_jours(1, 2021) == 31", "assert nb_jours(2, 2020) == 29", "assert nb_jours(2, 2021) == 28", "assert nb_jours(4, 2021) == 30"] }
      },
      {
        titre: "Logique devinette",
        consigne: "Fonction <code>verif_devinette(secret, essai)</code>. Retourne 'Trop grand', 'Trop petit' ou 'Gagn√©'.",
        code: "def verif_devinette(secret, essai):\n    # Comparez secret et essai\n    return \"\"",
        validation: { type: "function", tests: ["assert verif_devinette(10, 5) == 'Trop petit'", "assert verif_devinette(10, 15) == 'Trop grand'", "assert verif_devinette(10, 10) == 'Gagn√©'"] }
      },
      {
        titre: "Pierre-Feuille-Ciseaux",
        consigne: "Fonction <code>gagnant_pfc(j1, j2)</code> (valeurs: 'P', 'F', 'C'). Retourne 'J1', 'J2' ou 'Nul'.",
        code: "def gagnant_pfc(j1, j2):\n    if j1 == j2: return 'Nul'\n    # Logique pour P, F, C\n    return 'J1'",
        validation: { type: "function", tests: ["assert gagnant_pfc('P', 'C') == 'J1'", "assert gagnant_pfc('P', 'F') == 'J2'", "assert gagnant_pfc('F', 'F') == 'Nul'"] }
      },
      {
        titre: "Fr√©quence des faces",
        consigne: "Simulez 100 lancers et affichez la liste des fr√©quences pour les faces 1 √† 6.",
        code: "import random\nfreq = [0] * 6\n# Simulez 100 lancers et remplissez freq\nprint(freq)",
        validation: { type: "manual", hint: "La sortie doit √™tre une liste de 6 nombres dont la somme fait 100." }
      }
    ];

    // ==========================================
    // LOGIQUE DE L'APPLICATION
    // ==========================================
    let editor, pyodide;
    let currentIdx = 0;
    const outputDiv = document.getElementById("output");
    const statusDiv = document.getElementById("status");
    const runBtn = document.getElementById("runBtn");

    // Initialisation Ace Editor
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/tomorrow_night_bright");
    editor.session.setMode("ace/mode/python");
    editor.setFontSize(16);

    // Initialisation Pyodide
    async function initPyodide() {
      try {
        pyodide = await loadPyodide();
        outputDiv.innerText = "Environnement Python pr√™t. Cliquez sur 'Ex√©cuter'.\n";
        runBtn.disabled = false;
        document.getElementById("progressText").innerText = `Pr√™t`;
        loadExercise(0);
      } catch (err) {
        outputDiv.innerText = "Erreur de chargement de Python. V√©rifiez votre connexion.\n" + err;
      }
    }
    initPyodide();

    function loadExercise(index) {
      currentIdx = index;
      const ex = exercices[index];

      document.getElementById("exTitle").innerText = `${index + 1}. ${ex.titre}`;
      document.getElementById("exInstruction").innerHTML = ex.consigne;
      document.getElementById("progressText").innerText = `Exercice ${index + 1} / ${exercices.length}`;

      editor.setValue(ex.code, -1);

      outputDiv.innerText = "";
      statusDiv.style.display = "none";
      statusDiv.className = "status-msg";

      // Navigation state
      document.getElementById("btnPrev").disabled = (index === 0);
      document.getElementById("btnNext").disabled = (index === exercices.length - 1);
    }

    async function runCode() {
      const ex = exercices[currentIdx];
      const userCode = editor.getValue();

      outputDiv.innerText = "";
      statusDiv.style.display = "none";
      runBtn.disabled = true;
      runBtn.innerHTML = '<span class="loader"></span> ...';

      // Capture stdout
      pyodide.setStdout({ batched: (msg) => outputDiv.innerText += msg + "\n" });

      try {
        // 1. Ex√©cution du code utilisateur
        await pyodide.runPythonAsync(userCode);

        // 2. Validation
        let success = false;
        let message = "";

        if (ex.validation.type === "manual") {
          statusDiv.className = "status-msg success";
          statusDiv.style.background = "#fff3cd";
          statusDiv.style.color = "#856404";
          statusDiv.style.borderColor = "#ffeeba";
          statusDiv.innerHTML = `‚ö†Ô∏è <strong>Validation manuelle :</strong><br>${ex.validation.hint}`;
          statusDiv.style.display = "block";
          resetBtnState();
          return;
        }

        if (ex.validation.type === "output_list") {
          // V√©rifie une liste exacte de lignes
          const userLines = outputDiv.innerText.trim().split('\n').map(s => s.trim()).filter(s => s !== "");
          const expected = ex.validation.values;

          success = (userLines.length === expected.length) &&
            userLines.every((val, index) => val == expected[index]);

          if (!success) message = `Sortie attendue : ${expected.slice(0, 5).join(", ")}... <br> Obtenue : ${userLines.slice(0, 5).join(", ")}...`;
        }
        else if (ex.validation.type === "output_includes") {
          // V√©rifie si la sortie CONTIENT les lignes attendues
          const content = outputDiv.innerText;
          success = ex.validation.values.every(val => content.includes(val));
          if (!success) message = "Votre affichage ne contient pas toutes les valeurs attendues.";
        }
        else if (ex.validation.type === "function") {
          // Ex√©cute les assertions
          try {
            for (let test of ex.validation.tests) {
              await pyodide.runPythonAsync(test);
            }
            success = true;
          } catch (e) {
            success = false;
            message = "La fonction ne retourne pas le bon r√©sultat pour tous les cas de test.";
          }
        }

        // Affichage R√©sultat
        statusDiv.style.display = "block";
        if (success) {
          statusDiv.className = "status-msg success";
          statusDiv.innerHTML = "‚úÖ Bravo ! Exercice valid√©.";
        } else {
          statusDiv.className = "status-msg error";
          statusDiv.innerHTML = `‚ùå Incorrect.<br><small>${message}</small>`;
        }

      } catch (err) {
        outputDiv.innerText += "\nüõë Erreur Python :\n" + err;
        statusDiv.style.display = "block";
        statusDiv.className = "status-msg error";
        statusDiv.innerHTML = "Votre code contient une erreur de syntaxe ou d'ex√©cution.";
      }

      resetBtnState();
    }

    function resetBtnState() {
      runBtn.disabled = false;
      runBtn.innerHTML = '<span id="btnIcon">‚ñ∂</span> Ex√©cuter';
    }

    function resetCode() {
      if (confirm("Voulez-vous vraiment remettre le code √† z√©ro ?")) {
        editor.setValue(exercices[currentIdx].code, -1);
        outputDiv.innerText = "";
        statusDiv.style.display = "none";
      }
    }

    function nextExercise() { if (currentIdx < exercices.length - 1) loadExercise(currentIdx + 1); }
    function prevExercise() { if (currentIdx > 0) loadExercise(currentIdx - 1); }
  </script>
</body>

</html>